# templates/docker-compose.yml.j2

version: "3.9"

services:
  ignition-dev:
    image: {{ image_repo }}:{{ image_tag }}
    container_name: ignition-dev
    restart: unless-stopped

    extra_hosts:
      - "host.docker.internal:host-gateway"

    env_file:
      - .env

    environment:
      ACCEPT_IGNITION_EULA: ${ACCEPT_IGNITION_EULA:-Y}
      GATEWAY_ADMIN_USERNAME: ${GATEWAY_ADMIN_USERNAME}
      GATEWAY_ADMIN_PASSWORD: ${GATEWAY_ADMIN_PASSWORD}
      IGNITION_EDITION: ${IGNITION_EDITION}
      TZ: ${TZ}
      {% if gateway_modules_enabled %}
      GATEWAY_MODULES_ENABLED: ${GATEWAY_MODULES_ENABLED}
      {% endif %}
      {% if gateway_module_relink %}
      GATEWAY_MODULE_RELINK: ${GATEWAY_MODULE_RELINK}
      {% endif %}
      {% if gateway_jdbc_relink %}
      GATEWAY_JDBC_RELINK: ${GATEWAY_JDBC_RELINK}
      {% endif %}
      {% if ignition_uid is not none %}
      IGNITION_UID: ${IGNITION_UID}
      {% endif %}
      {% if ignition_gid is not none %}
      IGNITION_GID: ${IGNITION_GID}
      {% endif %}
      {% if activation_token_container_path %}
      IGNITION_ACTIVATION_TOKEN_FILE: ${IGNITION_ACTIVATION_TOKEN_FILE}
      {% endif %}
      {% if license_key_container_path %}
      IGNITION_LICENSE_KEY_FILE: ${IGNITION_LICENSE_KEY_FILE}
      {% endif %}
      {% if conn_type == 'ethernet' and device_ip %}
      DEVICE_HOST: "{{ device_ip }}"
      {% endif %}
      {% if conn_type == 'ethernet' and device_port %}
      DEVICE_PORT: "{{ device_port }}"
      {% endif %}
      {% if conn_type == 'serial' and baud_rate %}
      SERIAL_BAUD: "{{ baud_rate }}"
      {% endif %}
      {% if mode == 'backup' %}
      GATEWAY_AUTO_RESTORE_ENABLED: "true"
      {% endif %}

    ports:
      - "{{ http_port }}:8088"
      - "{{ https_port }}:8043"

    volumes:
{% for volume in volume_mounts %}
      - type: {{ volume.type }}
        source: {{ volume.source | tojson }}
        target: {{ volume.target | tojson }}
{% if volume.read_only %}
        read_only: true
{% endif %}
{% endfor %}

    {% if conn_type == 'serial' and com_port %}
    devices:
      - "{{ com_port }}:{{ com_port }}"
    {% endif %}

    command:
      - -n
      - "{{ gateway_name }}"
      {% if mode == 'backup' %}
      - -r
      - /restore.gwbk
      {% endif %}
      - --
      - wrapper.java.initmemory=512
      - wrapper.ignition.allowunsignedmodules=true

{% if declared_volumes %}
volumes:
{% for name in declared_volumes %}
  {{ name }}:
{% endfor %}
{% endif %}
